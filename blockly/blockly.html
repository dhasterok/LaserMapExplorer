<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Blockly Demo</title>
    <!-- Load Blockly core -->
    <script src="https://unpkg.com/blockly/blockly_compressed.js"></script>
    <!-- Load the default blocks -->
    <script src="https://unpkg.com/blockly/blocks_compressed.js"></script>
    <!-- Load a generator -->
    <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
    <!-- Load a message file -->
    <script src="https://unpkg.com/blockly/msg/en.js"></script>
    <script src="https://unpkg.com/blockly/python_compressed"></script>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script> <!-- Include the WebChannel library -->
    <script>
        /******************************
         * Custom Blockly Blocks
         ******************************/
    
        // Block: Load Directory
        const load_directory = {
            init: function() {
                this.appendValueInput('DIR')
                    .setCheck('String')
                    .appendField('load files from directory')
                    .appendField(new Blockly.FieldTextInput('directory name'), 'DIR');
                this.setNextStatement(true, null);
                this.setTooltip('Loads files from a directory');
                this.setHelpUrl('');
                this.setColour(225);
            }
        };
        Blockly.common.defineBlocks({ load_directory: load_directory });
    
        // Block: Sample IDs List
        const sample_ids_list_block = {
            init: function() {
                this.appendDummyInput()
                    .appendField("sample IDs list");
                this.setOutput(true, "Array");  // Outputs an array
                this.setColour(230);
                this.setTooltip('Represents a list of sample IDs');
                this.setHelpUrl('');
            }
        };
        Blockly.common.defineBlocks({ sample_ids_list_block: sample_ids_list_block });
        
        // Block: Select Samples
        const select_samples = {
            init: function() {
                // Create a dropdown field that will dynamically update
                this.appendDummyInput()
                    .appendField('Select sample ID')
                    .appendField(new Blockly.FieldDropdown(this.getOptions), 'SAMPLE_IDS');
                // Create a Blockly variable to store the selected sample ID
                this.appendDummyInput()
                    .appendField('Store selected sample in variable')
                    .appendField(new Blockly.FieldVariable('sample_id'), 'SAMPLE_VAR');
        
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip('Selects a sample ID');
                this.setHelpUrl('');
            },
            getOptions: function() {
                // If sample_ids is empty, return a default option
                if (!sample_ids.length) {
                    return [['No sample IDs available', 'NONE']];
                }
                // Convert sample_ids into a format for the dropdown
                return sample_ids.map(id => [id, id]);
            }
        };
        Blockly.common.defineBlocks({ select_samples: select_samples }); 



        // Block: Iterate Through Sample IDs
        const iterate_sample_ids = {
            init: function() {
                this.appendDummyInput()
                    .appendField("for each sample ID in")
                    .appendField(new Blockly.FieldVariable("sample_ids"), "SAMPLE_IDS");
    
                this.appendStatementInput("DO")
                    .appendField("do");
    
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(230);
                this.setTooltip('Iterate through each sample ID in the sample_ids list');
                this.setHelpUrl('');
            }
        };
        Blockly.common.defineBlocks({ iterate_sample_ids: iterate_sample_ids });
    
        /******************************
         * Python Generators for Custom Blocks
         ******************************/
    
        // Python Generator: Load Directory
        python.pythonGenerator.forBlock['load_directory'] = function(block, generator) {
            var dir_name = generator.quote_(block.getFieldValue('DIR'));
            // Generate code with or without directory parameter
            var code = (dir_name === "'directory name'")
                ? 'self.parent.open_directory()\nself.store_sample_ids()\n'
                : 'self.parent.open_directory(' + dir_name + ')\nself.store_sample_ids()\n';
            return code;
        };
    
        // Python Generator: Select Samples
        python.pythonGenerator.forBlock['select_samples'] = function(block, generator) {
            var sample_id = generator.quote_(block.getFieldValue('SAMPLE_ID'));
            var code = 'self.parent.sample_id =' + sample_id + '\n';
            return code;
        };
    
        // Python Generator: Sample IDs List
        python.pythonGenerator.forBlock['sample_ids_list_block'] = function(block, generator) {
            const code = JSON.stringify(sample_ids);  // Generates Python list from global sample_ids variable
            return [code, python.ORDER_ATOMIC];
        };
    
        // Python Generator: Iterate Through Sample IDs
        python.pythonGenerator.forBlock['iterate_sample_ids'] = function(block, generator) {
            var variable_sample_ids = JSON.stringify(sample_ids);
            var statements_do = generator.statementToCode(block, 'DO');
            var code = 'for sample_id in ' + variable_sample_ids + ':\n' + statements_do;
            return code;
        };
    
        /******************************
         * Helper Functions
         ******************************/
    
        // Function: Update Sample Dropdown with IDs
        function updateSampleDropdown(sampleIds) {
            storeSampleIdsAsList(sampleIds);  // Store sample IDs as Blockly list
    
            const dropdownOptions = sampleIds.map(id => [id, id]);
            Blockly.getMainWorkspace().getAllBlocks().forEach(function(block) {
                if (block.type === 'select_samples') {
                    block.getField('SAMPLE_IDS').menuGenerator_ = dropdownOptions;  // Update dropdown options dynamically
                    block.getField('SAMPLE_IDS').setValue(dropdownOptions[0][0]);  // Set default value
                }
            });
            console.log("Dropdown updated with sample IDs:", dropdownOptions);
        }
    
        // Global variable to store sample IDs
        let sample_ids = [];
    
        // Function: Update the sample_ids list and refresh the dropdown
        function updateSampleIds(sampleIds) {
            // Update the global sample_ids variable
            sample_ids = sampleIds;

            // Refresh all blocks in the workspace that use the select_samples dropdown
            Blockly.getMainWorkspace().getAllBlocks().forEach(function(block) {
                if (block.type === 'select_samples') {
                    const dropdownField = block.getField('SAMPLE_IDS');
                    if (dropdownField) {
                        dropdownField.menuGenerator_ = sampleIds.map(id => [id, id]); // Update dropdown options dynamically
                        dropdownField.setValue(sampleIds.length ? sampleIds[0] : 'NONE'); // Set default value
                    }
                }
            });

            console.log("Dropdown updated with sample IDs:", sample_ids);
        }
    </script>    
</head>
<body>
    
    <div id="blocklyDiv" style="height: 600px; width: 1000px;"></div>
    <xml id="toolbox" style="display: none">
        <!-- Variables -->
        <category name="Variables" custom="VARIABLE" colour="330">
            <block type="variables_get"></block>
            <block type="variables_set"></block>
        </category>
    
        <!-- Lists -->
        <category name="Lists" colour="260">
            <block type="sample_ids_list_block"></block> <!-- Custom Block for Sample IDs List -->
            <block type="select_samples"></block> <!-- Custom Block for Selecting Sample IDs -->
        </category>
    
        <!-- Loops -->
        <category name="Loops" colour="120">
            <block type="controls_repeat_ext"></block>
            <block type="controls_for"></block>
            <block type="controls_whileUntil"></block>
            <block type="iterate_sample_ids"></block> <!-- Custom Loop Block -->
        </category>
    
        <!-- Logic -->
        <category name="Logic" colour="210">
            <block type="controls_if"></block>
            <block type="logic_compare"></block>
        </category>
    
        <!-- Math -->
        <category name="Math" colour="230">
            <block type="math_number"></block>
            <block type="math_arithmetic"></block>
        </category>
    
        <!-- Text -->
        <category name="Text" colour="160">
            <block type="text"></block>
            <block type="text_print"></block>
        </category>
    
        <!-- Custom Blocks -->
        <category name="Custom Blocks" colour="60">
            <block type="load_directory"></block> <!-- Custom Block -->
            <block type="select_samples"></block> <!-- Custom Block -->
        </category>
    </xml>
    <script>
        var workspace = Blockly.inject('blocklyDiv',
            {toolbox: document.getElementById('toolbox')});

        new QWebChannel(qt.webChannelTransport, function(channel) {
        window.blocklyBridge = channel.objects.blocklyBridge;

        function sendCodeToPython() {
            // Generate Python code from Blockly
            var code = python.pythonGenerator.workspaceToCode(workspace);
            
            // Send the code to Python via WebChannel
            if (window.blocklyBridge) {
                window.blocklyBridge.runCode(code);
            } else {
                console.log("No blocklyBridge available.");
            }
        }

        function executeBlocks(startBlock) {
            let block = startBlock;
            let code = '';
            //while (block) {
                // Ensure the Python generator is initialized for this workspace
                python.pythonGenerator.init(workspace);
                // Generate code for the block
                code = python.pythonGenerator.blockToCode(block) ;
                //block = block.getNextBlock();  // Move to the next block
            //}
            return code;
        }
        // Add a double-click listener for executing blocks
        workspace.addChangeListener(function(event) {
                if (event instanceof Blockly.Events.Click) {
                    // Detect double click
                    if (workspace.doubleClickPid_) {
                        clearTimeout(workspace.doubleClickPid_);
                        workspace.doubleClickPid_ = undefined;

                        // If the same block is clicked twice
                        if (event.blockId === workspace.doubleClickBlock_) {
                            var block = workspace.getBlockById(workspace.doubleClickBlock_);
                            if (block) {
                                // Execute the block and connected blocks
                                const code = executeBlocks(block);

                                // Send the generated code to Python
                                if (window.blocklyBridge) {
                                    window.blocklyBridge.executeCode(code);
                                } else {
                                    console.log("No blocklyBridge available.");
                                }
                            }
                            return;
                        }
                    }

                    // If this is the first click
                    if (!workspace.doubleClickPid_) {
                        workspace.doubleClickBlock_ = event.blockId;
                        workspace.doubleClickPid_ = setTimeout(function() {
                            workspace.doubleClickPid_ = undefined;
                        }.bind(workspace), 500);  // Wait 500ms to detect a second click
                    }
                }
            });
        workspace.addChangeListener(sendCodeToPython);
        });
    </script>
</body>
</html>
